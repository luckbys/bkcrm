# üö® CORRE√á√ÉO ERRO 404 - WEBHOOK EVOLUTION API

## ‚ùå **PROBLEMA IDENTIFICADO:**

A Evolution API est√° tentando enviar webhooks para endpoints do n8n que **N√ÉO EXISTEM**:

```
‚ùå ERRO: Request failed with status code 404
üîó URL: https://press-n8n.jhkbgs.easypanel.host/webhook/res/connection-update
üîó URL: https://press-n8n.jhkbgs.easypanel.host/webhook/res/messages-upsert
üîó URL: https://press-n8n.jhkbgs.easypanel.host/webhook/res/messages-update
```

**Tentativas:** 2/10, 5/10, 7/10, 8/10 ‚Üí Evolution API est√° falhando e tentando novamente

---

## ‚ö° **SOLU√á√ïES IMEDIATAS**

### **üéØ OP√á√ÉO 1: REMOVER WEBHOOKS INCORRETOS (RECOMENDADO)**

Execute no **Console do CRM** (F12 ‚Üí Console):

```javascript
// SCRIPT PARA REMOVER WEBHOOKS INCORRETOS
(async () => {
    console.log('üßπ INICIANDO LIMPEZA DE WEBHOOKS INCORRETOS...\n');
    
    try {
        // Importar servi√ßo
        const { evolutionApiService } = await import('@/services/evolutionApiService');
        
        // Listar todas as inst√¢ncias
        const instancesResult = await evolutionApiService.listInstances();
        const instances = instancesResult?.data || instancesResult || [];
        
        console.log(`üìã ${instances.length} inst√¢ncias encontradas\n`);
        
        let removedCount = 0;
        let errorCount = 0;
        
        // Verificar e remover webhooks incorretos
        for (const instance of instances) {
            const instanceName = instance.instanceName || instance.name || instance.instance?.instanceName;
            
            if (!instanceName) {
                console.log('‚ö†Ô∏è Inst√¢ncia sem nome, pulando...');
                continue;
            }
            
            try {
                console.log(`üîç Verificando: ${instanceName}`);
                
                // Verificar webhook atual
                const currentWebhook = await evolutionApiService.getInstanceWebhook(instanceName);
                const webhookUrl = currentWebhook?.webhook?.url;
                
                if (webhookUrl) {
                    console.log(`   üì° URL atual: ${webhookUrl}`);
                    
                    // Verificar se √© webhook incorreto (n8n com /res/)
                    if (webhookUrl.includes('n8n') && webhookUrl.includes('/webhook/res/')) {
                        console.log(`   ‚ùå WEBHOOK INCORRETO DETECTADO! Removendo...`);
                        
                        await evolutionApiService.removeInstanceWebhook(instanceName);
                        removedCount++;
                        
                        console.log(`   ‚úÖ Webhook removido com sucesso!\n`);
                    } else if (webhookUrl.includes('connection-update') || 
                               webhookUrl.includes('messages-upsert') || 
                               webhookUrl.includes('messages-update')) {
                        console.log(`   ‚ùå WEBHOOK COM ENDPOINT INCORRETO! Removendo...`);
                        
                        await evolutionApiService.removeInstanceWebhook(instanceName);
                        removedCount++;
                        
                        console.log(`   ‚úÖ Webhook removido com sucesso!\n`);
                    } else {
                        console.log(`   ‚úÖ Webhook OK (n√£o √© problem√°tico)\n`);
                    }
                } else {
                    console.log(`   ‚ÑπÔ∏è Sem webhook configurado\n`);
                }
                
            } catch (error) {
                console.error(`   ‚ùå Erro ao verificar ${instanceName}:`, error.message);
                errorCount++;
            }
        }
        
        // Resultado final
        console.log('üéØ RESULTADO DA LIMPEZA:');
        console.log(`‚úÖ Webhooks incorretos removidos: ${removedCount}`);
        console.log(`‚ùå Erros encontrados: ${errorCount}`);
        console.log(`üìã Total de inst√¢ncias verificadas: ${instances.length}`);
        
        if (removedCount > 0) {
            console.log('\nüéâ SUCESSO! Os erros 404 devem parar de aparecer nos logs da Evolution API.');
        } else {
            console.log('\nü§î Nenhum webhook incorreto encontrado. O problema pode estar em outro lugar.');
        }
        
    } catch (error) {
        console.error('‚ùå ERRO GERAL:', error);
        console.log('\nüîß SOLU√á√ÉO ALTERNATIVA: Execute os passos manuais abaixo.');
    }
})();
```

### **üéØ OP√á√ÉO 2: CONFIGURAR WEBHOOK CORRETO PARA O CRM**

Ap√≥s remover os incorretos, configure para receber no pr√≥prio CRM:

```javascript
// SCRIPT PARA CONFIGURAR WEBHOOK CORRETO
(async () => {
    console.log('üîß CONFIGURANDO WEBHOOK PARA O CRM...\n');
    
    try {
        const { evolutionApiService } = await import('@/services/evolutionApiService');
        
        // Determinar URL do CRM baseado no ambiente atual
        const currentDomain = window.location.hostname;
        const currentPort = window.location.port;
        const isLocalhost = currentDomain === 'localhost' || currentDomain === '127.0.0.1';
        
        let crmWebhookUrl;
        
        if (isLocalhost) {
            crmWebhookUrl = `http://localhost:${currentPort || '3000'}/api/webhook/evolution`;
        } else {
            crmWebhookUrl = `https://${currentDomain}/api/webhook/evolution`;
        }
        
        console.log(`üåê URL do CRM detectada: ${crmWebhookUrl}\n`);
        
        // Listar inst√¢ncias
        const instancesResult = await evolutionApiService.listInstances();
        const instances = instancesResult?.data || instancesResult || [];
        
        console.log(`üìã ${instances.length} inst√¢ncias encontradas\n`);
        
        let configuredCount = 0;
        
        // Configurar webhook correto para cada inst√¢ncia
        for (const instance of instances) {
            const instanceName = instance.instanceName || instance.name || instance.instance?.instanceName;
            
            if (!instanceName) continue;
            
            try {
                console.log(`üîß Configurando: ${instanceName}`);
                
                const webhookConfig = {
                    url: crmWebhookUrl,
                    enabled: true,
                    events: ['MESSAGES_UPSERT', 'CONNECTION_UPDATE', 'QRCODE_UPDATED']
                };
                
                await evolutionApiService.setInstanceWebhook(instanceName, webhookConfig);
                configuredCount++;
                
                console.log(`   ‚úÖ Webhook configurado com sucesso!\n`);
                
            } catch (error) {
                console.error(`   ‚ùå Erro ao configurar ${instanceName}:`, error.message);
            }
        }
        
        console.log('üéØ RESULTADO:');
        console.log(`‚úÖ Inst√¢ncias configuradas: ${configuredCount}`);
        console.log(`üîó URL configurada: ${crmWebhookUrl}`);
        
    } catch (error) {
        console.error('‚ùå ERRO:', error);
    }
})();
```

---

## üîç **DIAGN√ìSTICO AVAN√áADO**

Execute para investigar o estado atual:

```javascript
// SCRIPT DE DIAGN√ìSTICO COMPLETO
(async () => {
    console.log('üîç DIAGN√ìSTICO COMPLETO DE WEBHOOKS\n');
    
    try {
        const { evolutionApiService } = await import('@/services/evolutionApiService');
        
        // Verificar conex√£o com Evolution API
        console.log('1Ô∏è‚É£ TESTANDO CONEX√ÉO COM EVOLUTION API...');
        try {
            const connectionTest = await evolutionApiService.testConnection();
            console.log('   ‚úÖ Conex√£o OK:', connectionTest);
        } catch (error) {
            console.error('   ‚ùå Falha na conex√£o:', error.message);
            return;
        }
        
        // Listar inst√¢ncias e seus webhooks
        console.log('\n2Ô∏è‚É£ ANALISANDO INST√ÇNCIAS E WEBHOOKS...');
        const instancesResult = await evolutionApiService.listInstances();
        const instances = instancesResult?.data || instancesResult || [];
        
        console.log(`üìã Total de inst√¢ncias: ${instances.length}\n`);
        
        const problemInstances = [];
        
        for (const instance of instances) {
            const instanceName = instance.instanceName || instance.name || instance.instance?.instanceName;
            
            if (!instanceName) continue;
            
            console.log(`üîç INST√ÇNCIA: ${instanceName}`);
            console.log(`   üìä Status: ${instance.state || instance.status || 'unknown'}`);
            
            try {
                const webhook = await evolutionApiService.getInstanceWebhook(instanceName);
                const webhookUrl = webhook?.webhook?.url;
                
                if (webhookUrl) {
                    console.log(`   üì° Webhook: ${webhookUrl}`);
                    
                    // Verificar se √© problem√°tico
                    if (webhookUrl.includes('/webhook/res/') || 
                        webhookUrl.includes('connection-update') ||
                        webhookUrl.includes('messages-upsert')) {
                        console.log('   üö® PROBLEM√ÅTICO! (Causa dos erros 404)');
                        problemInstances.push({
                            name: instanceName,
                            url: webhookUrl
                        });
                    } else {
                        console.log('   ‚úÖ OK');
                    }
                } else {
                    console.log('   ‚ÑπÔ∏è Sem webhook configurado');
                }
                
            } catch (error) {
                console.log(`   ‚ùå Erro ao verificar webhook: ${error.message}`);
            }
            
            console.log('');
        }
        
        // Resumo dos problemas
        console.log('üéØ RESUMO:');
        console.log(`‚ùå Inst√¢ncias com webhook problem√°tico: ${problemInstances.length}`);
        
        if (problemInstances.length > 0) {
            console.log('\nüö® INST√ÇNCIAS PROBLEM√ÅTICAS:');
            problemInstances.forEach(item => {
                console.log(`   ‚Ä¢ ${item.name}: ${item.url}`);
            });
            
            console.log('\nüí° RECOMENDA√á√ÉO: Execute o script de limpeza (Op√ß√£o 1) para resolver.');
        } else {
            console.log('\n‚úÖ Nenhum webhook problem√°tico encontrado!');
        }
        
    } catch (error) {
        console.error('‚ùå ERRO NO DIAGN√ìSTICO:', error);
    }
})();
```

---

## üõ†Ô∏è **CORRE√á√ÉO MANUAL (Se os scripts n√£o funcionarem)**

### **1. Via API REST Diretamente:**

```bash
# 1. Listar inst√¢ncias
curl -X GET "https://press-evolution-api.jhkbgs.easypanel.host/instance/fetchInstances" \
  -H "apikey: SUA_API_KEY_AQUI"

# 2. Remover webhook de inst√¢ncia espec√≠fica
curl -X DELETE "https://press-evolution-api.jhkbgs.easypanel.host/webhook/set/NOME_DA_INSTANCIA" \
  -H "apikey: SUA_API_KEY_AQUI"

# 3. Configurar webhook correto
curl -X POST "https://press-evolution-api.jhkbgs.easypanel.host/webhook/set/NOME_DA_INSTANCIA" \
  -H "apikey: SUA_API_KEY_AQUI" \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://seu-crm.com/api/webhook/evolution",
    "enabled": true,
    "events": ["MESSAGES_UPSERT", "CONNECTION_UPDATE"]
  }'
```

### **2. Via Evolution API Dashboard:**

1. Acesse: `https://press-evolution-api.jhkbgs.easypanel.host/manager`
2. V√° em **Webhooks** 
3. **Delete** webhooks com URLs incorretas
4. **Configure** URL correta do seu CRM

---

## ‚úÖ **VERIFICA√á√ÉO DE SUCESSO**

Ap√≥s aplicar as corre√ß√µes:

1. **Logs da Evolution API** devem parar os erros 404
2. **Console do navegador** n√£o deve mostrar erros de webhook
3. **Mensagens do WhatsApp** devem funcionar normalmente

### **Comando de verifica√ß√£o:**

```javascript
// Verificar se a corre√ß√£o funcionou
(async () => {
    const { evolutionApiService } = await import('@/services/evolutionApiService');
    const instances = await evolutionApiService.listInstances();
    
    console.log('üîç VERIFICA√á√ÉO FINAL:');
    
    for (const instance of instances.data || instances) {
        const name = instance.instanceName || instance.name;
        if (!name) continue;
        
        try {
            const webhook = await evolutionApiService.getInstanceWebhook(name);
            const url = webhook?.webhook?.url;
            
            if (url) {
                const isCorrect = !url.includes('/webhook/res/') && 
                                 !url.includes('connection-update') &&
                                 !url.includes('messages-upsert');
                
                console.log(`${isCorrect ? '‚úÖ' : '‚ùå'} ${name}: ${url}`);
            } else {
                console.log(`‚ÑπÔ∏è ${name}: Sem webhook`);
            }
        } catch (error) {
            console.log(`‚ùå ${name}: Erro - ${error.message}`);
        }
    }
})();
```

---

## üöÄ **PR√ìXIMOS PASSOS**

Ap√≥s corrigir os webhooks:

1. **Monitor de logs** da Evolution API para confirmar que os erros 404 pararam
2. **Teste envio/recebimento** de mensagens WhatsApp
3. **Configure monitoramento** para evitar problemas futuros
4. **Documente URLs corretas** para refer√™ncia da equipe

---

> **üí° IMPORTANTE:** Os erros 404 s√£o causados por URLs de webhook incorretas configuradas nas inst√¢ncias. A Evolution API tenta enviar para endpoints que n√£o existem no n8n, causando falhas e retries constantes. 